#!/usr/bin/env bash

set -euo pipefail

export AWS_PROFILE=zenml
export AWS_REGION=us-west-2
export AWS_DEFAULT_REGION=${AWS_REGION}

# https://docs.zenml.io/getting-started/installation#local-dashboard
# If you want to run a local server while running on a Mac with Apple Silicon,
# you should set the following environment variable:
export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES

THIS_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"


tf_init() {
	terraform -chdir="${THIS_DIR}/infrastructure" init
}

deploy_infra() {
	source "$THIS_DIR/.env"

	# Set Terraform variables for Grafana OTLP endpoint and API key
	export TF_VAR_grafana_otlp_endpoint="${OTEL_EXPORTER_OTLP_ENDPOINT}"
	export TF_VAR_grafana_otlp_auth_header="${OTEL_EXPORTER_OTLP_HEADERS}"

	# Check if aws profile is active
	aws sts get-caller-identity > /dev/null 2>&1 || {
		echo "AWS profile '${AWS_PROFILE}' is not active. Please configure it and try again."
		exit 1
	}

	terraform -chdir="${THIS_DIR}/infrastructure" fmt
	terraform -chdir="${THIS_DIR}/infrastructure" validate
	# terraform -chdir="${THIS_DIR}/infrastructure" plan
	terraform -chdir="${THIS_DIR}/infrastructure" apply

}


zenml_login:local() {
	uv run zenml login --local
}

run_pipeline() {
	uv run src/run.py
}

deploy_pipeline:local() {
	uv run zenml init
	uv run zenml pipeline deploy src.run:cloud_migration_pipeline
}


# remove all files generated by tests, builds, or operating this codebase
clean() {
	set -x

	rm -rf dist build coverage.xml test-reports/
	find . \
	  -type d \
	  \( \
		-name "*cache*" \
		-o -name "*.dist-info" \
		-o -name "*.egg-info" \
		-o -name "*htmlcov" \
        -o -name "cdk.out" \
	  \) \
	  -not -path "*env*/*" \
	  -exec rm -r {} + || true

	find . \
	  -type f \
	  -name "*.pyc" \
	  -not -path "*env/*" \
	  -exec rm {} +
}


# print all functions in this file
help() {
    echo "$0 <task> <args>"
    echo "Tasks:"
    compgen -A function | cat -n
}


TIMEFORMAT="Task completed in %3lR"
time ${@:-help}