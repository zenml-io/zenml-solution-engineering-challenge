#!/usr/bin/env bash

set -euo pipefail

export AWS_PROFILE=sandbox
export AWS_REGION=us-west-2
export AWS_DEFAULT_REGION=${AWS_REGION}

# # aws account id/hash used to make a unique, but consistent bucket name
# AWS_ACCOUNT_ID=$(aws sts get-caller-identity --profile $AWS_PROFILE --query "Account" --output text || echo "")

# # Only create bucket name if AWS_ACCOUNT_ID is available
# # Suppress errors if profile doesn't exist (e.g., in CI/CD)
# if [ -n "$AWS_ACCOUNT_ID" ]; then
#     AWS_ACCOUNT_ID_HASH=$(echo -n "${AWS_ACCOUNT_ID}" | sha256sum | cut -c5-8)
#     export S3_BUCKET_NAME="terraform-playground-bucket-${AWS_ACCOUNT_ID_HASH}" # terraform-playground-bucket-6721
# else
#     echo "WARNING: Could not retrieve AWS Account ID. Profile '$AWS_PROFILE' may not exist."
# 	echo "S3_BUCKET_NAME environment variable will not be set."
# fi

# https://docs.zenml.io/getting-started/installation#local-dashboard
# If you want to run a local server while running on a Mac with Apple Silicon,
# you should set the following environment variable:
export OBJC_DISABLE_INITIALIZE_FORK_SAFETY=YES

THIS_DIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" >/dev/null 2>&1 && pwd )"



zenml_login() {
	uv run zenml login --local
}

run_pipeline() {
	uv run src/run.py
}

deploy_pipeline() {
	uv run zenml init
	uv run zenml pipeline deploy src.run:cloud_migration_pipeline
}


# remove all files generated by tests, builds, or operating this codebase
clean() {
	set -x

	rm -rf dist build coverage.xml test-reports/
	find . \
	  -type d \
	  \( \
		-name "*cache*" \
		-o -name "*.dist-info" \
		-o -name "*.egg-info" \
		-o -name "*htmlcov" \
        -o -name "cdk.out" \
	  \) \
	  -not -path "*env*/*" \
	  -exec rm -r {} + || true

	find . \
	  -type f \
	  -name "*.pyc" \
	  -not -path "*env/*" \
	  -exec rm {} +
}


# print all functions in this file
help() {
    echo "$0 <task> <args>"
    echo "Tasks:"
    compgen -A function | cat -n
}


TIMEFORMAT="Task completed in %3lR"
time ${@:-help}